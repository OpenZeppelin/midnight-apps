[build]
  base = "apps/lunarswap-ui"
  publish = ".next"
  command = """
  set -euo pipefail
  corepack enable
  corepack prepare pnpm@10.4.1 --activate

  # Move from base to repo root
  cd ..

  # 1) Install compactc where your builder expects it
  COMPACT_HOME="$PWD/packages/compact/compactc"
  mkdir -p "$COMPACT_HOME"
  COMPILER_VERSION=0.23.0
  ZIP="compactc_v${COMPILER_VERSION}_x86_64-unknown-linux-musl.zip"
  URL="https://d3fazakqrumx6p.cloudfront.net/artifacts/compiler/compactc_${COMPILER_VERSION}/${ZIP}"
  curl -Ls "$URL" -o "$COMPACT_HOME/compactc.zip"
  unzip -qo "$COMPACT_HOME/compactc.zip" -d "$COMPACT_HOME"
  chmod +x "$COMPACT_HOME"/{compactc,compactc.bin,zkir}
  export COMPACT_HOME PATH="$COMPACT_HOME:$PATH"
  "$COMPACT_HOME/compactc" --version

  # 2) Prebuild packages/compact so dist/run*.js exist
  pushd packages/compact >/dev/null
  pnpm install --frozen-lockfile --prefer-offline --ignore-scripts
  pnpm run build
  popd >/dev/null

  # 3) Now run skipped lifecycle scripts across the workspace
  pnpm rebuild -r

  # 4) Build the app
  cd apps/lunarswap-ui
  pnpm run build
  """

[build.environment]
  NODE_VERSION = "22"
  PNPM_VERSION = "10.4.1"
  # Make Netlify's auto "pnpm install" skip scripts so it doesn't fail early
  PNPM_FLAGS = "--ignore-scripts"
  # Allow lifecycle scripts when we run them ourselves later
  PNPM_ALLOW_SCRIPT = "1"
  PNPM_ENABLE_PREPOST_SCRIPTS = "true"

[[plugins]]
  package = "@netlify/plugin-nextjs"

[[redirects]]
  from = "/lunarswap/*"
  to = "https://lunarswap.netlify.app/:splat"
  status = 200
  force = true
