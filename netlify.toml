[build]
  base = "apps/lunarswap-ui"
  publish = ".next"
  command = """
  set -euo pipefail
  corepack enable
  corepack prepare pnpm@10.4.1 --activate

  cd ..   # repo root

  # 1) Install compactc where your packages expect it
  COMPACT_HOME="$PWD/packages/compact/compactc"
  mkdir -p "$COMPACT_HOME"
  V=0.23.0
  ZIP="compactc_v${V}_x86_64-unknown-linux-musl.zip"
  URL="https://d3fazakqrumx6p.cloudfront.net/artifacts/compiler/compactc_${V}/${ZIP}"
  curl -Ls "$URL" -o "$COMPACT_HOME/compactc.zip"
  unzip -qo "$COMPACT_HOME/compactc.zip" -d "$COMPACT_HOME"
  chmod +x "$COMPACT_HOME"/{compactc,compactc.bin,zkir}
  export COMPACT_HOME PATH="$COMPACT_HOME:$PATH"
  "$COMPACT_HOME/compactc" --version

  # 2) EXACTLY what you suggested: prebuild local compact first
  cd packages/compact
  pnpm install --prefer-offline --ignore-scripts
  pnpm run build
  test -f dist/runCompiler.js
  test -f dist/runBuilder.js
  cd ../../

  # 3) Nuke existing node_modules to force pnpm to relink .bin properly
  find . -name node_modules -type d -prune -exec rm -rf {} +
  rm -rf pnpm-lock.yaml .pnpm-debug.log || true
  pnpm install

  # 4) Build workspaces, then the Next app
  pnpm -r --workspace-concurrency=1 run build
  cd apps/lunarswap-ui
  pnpm run build
  """

[build.environment]
  NODE_VERSION = "22"
  PNPM_VERSION = "10.4.1"
  PNPM_FLAGS = "--ignore-scripts"            # keep Netlify auto-install from running scripts early
  PNPM_ALLOW_SCRIPT = "1"
  PNPM_ENABLE_PREPOST_SCRIPTS = "true"
