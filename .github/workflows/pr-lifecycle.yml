name: PR Lifecycle

on:
  pull_request:
    types: [opened, reopened, converted_to_draft, ready_for_review, closed]

permissions: {}

jobs:
  update-project-status:
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - name: Update project status
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          PROJECT_ID: ${{ vars.PROJECT_ID }}
          STATUS_FIELD_ID: ${{ vars.PROJECT_STATUS_FIELD_ID }}
          STATUS_OPTION_IN_PROGRESS: ${{ vars.PROJECT_IN_PROGRESS_COLUMN_NODE_ID }}
          STATUS_OPTION_NEEDS_REVIEW: ${{ vars.PROJECT_NEEDS_REVIEW_COLUMN_NODE_ID }}
          STATUS_OPTION_CLOSED: ${{ vars.PROJECT_CLOSED_COLUMN_NODE_ID }}
        with:
          github-token: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const PROJECT_ID      = process.env.PROJECT_ID;
            const STATUS_FIELD_ID = process.env.STATUS_FIELD_ID;
            const STATUS_OPTIONS  = {
              in_progress:  process.env.STATUS_OPTION_IN_PROGRESS,
              needs_review: process.env.STATUS_OPTION_NEEDS_REVIEW,
              closed:       process.env.STATUS_OPTION_CLOSED,
            };

            // Validate required environment variables
            const missing = [];
            if (!PROJECT_ID) missing.push('PROJECT_ID');
            if (!STATUS_FIELD_ID) missing.push('STATUS_FIELD_ID');
            if (!STATUS_OPTIONS.in_progress) missing.push('STATUS_OPTION_IN_PROGRESS');
            if (!STATUS_OPTIONS.needs_review) missing.push('STATUS_OPTION_NEEDS_REVIEW');
            if (!STATUS_OPTIONS.closed) missing.push('STATUS_OPTION_CLOSED');

            if (missing.length > 0) {
              throw new Error(`Missing required environment variables: ${missing.join(', ')}`);
            }

            // Determine target status
            const { action, pull_request: pr } = context.payload;
            let targetStatus;

            if (action === "closed") {
              targetStatus = STATUS_OPTIONS.closed;
            } else if (action === "ready_for_review") {
              targetStatus = STATUS_OPTIONS.needs_review;
            } else if (action === "converted_to_draft") {
              targetStatus = STATUS_OPTIONS.in_progress;
            } else if (action === "opened" || action === "reopened") {
              targetStatus = pr.draft
                ? STATUS_OPTIONS.in_progress
                : STATUS_OPTIONS.needs_review;
            }

            if (!targetStatus) return;

            // 1. Add PR to project (idempotent — safe to call even if already added)
            const addResult = await github.graphql(`
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {
                  projectId: $projectId
                  contentId: $contentId
                }) {
                  item { id }
                }
              }
            `, {
              projectId: PROJECT_ID,
              contentId: pr.node_id,
            });

            const itemId = addResult.addProjectV2ItemById.item.id;

            // 2. Set the Status field
            await github.graphql(`
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item { id }
                }
              }
            `, {
              projectId: PROJECT_ID,
              itemId,
              fieldId: STATUS_FIELD_ID,
              optionId: targetStatus,
            });

            console.log(`PR #${pr.number} → status set for action: ${action}`);
